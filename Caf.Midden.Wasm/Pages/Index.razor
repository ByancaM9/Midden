@page "/"
@inject Services.StateContainer State

<div class="site-layout-background">
    <CatalogLoader />
    @if (State?.AppConfig != null)
    {
        <PageHeader Class="site-page-header"
                    Title="@State.AppConfig.OrganizationName"
                    Subtitle="Metadata Tool" />
    }
    <Divider />

    <AntDesign.Row Gutter="16">
        <AntDesign.Col Span="4">
            <Card Bordered="false" Size="small">
                <Statistic Title="Last Updated" Value="@($"{CatalogLastUpdate.Month}/{CatalogLastUpdate.Day}/{CatalogLastUpdate.Year}")">
                    <PrefixTemplate>
                        <span><Icon Type="calendar" /></span>
                    </PrefixTemplate>
                </Statistic>
            </Card>
        </AntDesign.Col>
        <AntDesign.Col Span="4">
            <a href="catalog/projects">
                <Card Hoverable Bordered="false" Size="small">
                    <Statistic Title="Total Projects" Value="@TotalProjects">
                        <PrefixTemplate>
                            <span><Icon Type="project" /></span>
                        </PrefixTemplate>
                    </Statistic>
                </Card>
            </a>
        </AntDesign.Col>
        <AntDesign.Col Span="4">
            <a href="catalog/datasets">
                <Card Hoverable Bordered="false" Size="small">
                    <Statistic Title="Total Datasets" Value="@TotalDatasets">
                        <PrefixTemplate>
                            <span><Icon Type="file-text" /></span>
                        </PrefixTemplate>
                    </Statistic>
                </Card>
            </a>
        </AntDesign.Col>
        <AntDesign.Col Span="4">
            <a href="catalog/variables">
                <Card Hoverable Bordered="false" Size="small">
                    <Statistic Title="Total Variables" Value="@TotalVariables">
                        <PrefixTemplate>
                            <span><Icon Type="calculator" /></span>
                        </PrefixTemplate>
                    </Statistic>
                </Card>
            </a>
        </AntDesign.Col>
        <AntDesign.Col Span="4">
            <Card Bordered="false" Size="small">
                <Statistic Title="Unique Tags" Value="@TotalTags">
                    <PrefixTemplate>
                        <span><Icon Type="tags" /></span>
                    </PrefixTemplate>
                </Statistic>
            </Card>
        </AntDesign.Col>
        <AntDesign.Col Span="4">
            <Card Bordered="false" Size="small">
                <Statistic Title="Contributors" Value="@TotalContacts">
                    <PrefixTemplate>
                        <span><Icon Type="user" /></span>
                    </PrefixTemplate>
                </Statistic>
            </Card>
        </AntDesign.Col>
    </AntDesign.Row>

    <Divider />

    <AntDesign.Row Gutter="16">
        <AntDesign.Col Span="12" Style="padding: 5px;">
            <AntDesign.AntList DataSource="@TopDatasetTags"
                               Bordered>
                <Header>Top Dataset Tags</Header>
                <ChildContent Context="item">
                    <ListItem>

                        <span><a href="catalog/datasets/tags/@item.Key"><Text>@item.Key</Text></a></span> @item.Value
                    </ListItem>
                </ChildContent>
            </AntDesign.AntList>
        </AntDesign.Col>
        <AntDesign.Col Span="12" Style="padding: 5px;">
            <AntDesign.AntList DataSource="@TopVariableTags"
                               Bordered>
                <Header>Top Variable Tags</Header>
                <ChildContent Context="item">
                    <ListItem>

                        <span><a href="catalog/variables/tags/@item.Key"><Text>@item.Key</Text></a></span> @item.Value
                    </ListItem>
                </ChildContent>
            </AntDesign.AntList>
        </AntDesign.Col>
    </AntDesign.Row>
    <AntDesign.Row Gutter="16">
        <AntDesign.Col Span="16" Style="padding: 5px;">
            <AntDesign.AntList DataSource="@TopContacts"
                               Bordered>
                <Header>Top Contributors</Header>
                <ChildContent Context="item">
                    <ListItem>
                        <span><Text>@item.Key</Text></span> @item.Value
                    </ListItem>
                </ChildContent>
            </AntDesign.AntList>
        </AntDesign.Col>
    </AntDesign.Row>

    <Row Gutter="16">
        <AntDesign.Col Span="8">
            <a href="insights">
                <Card Hoverable>
                    <CardMeta Title="Insights" Description="Stats for nerds" />
                </Card>
            </a>
        </AntDesign.Col>
        <AntDesign.Col Span="8">
            <a href="catalog/datasets">
                <Card Hoverable>
                    <CardMeta Title="Dataset Catalog" Description="Find and view datasets" />
                </Card>
            </a>
        </AntDesign.Col>
        <AntDesign.Col Span="8">
            <a href="editor/dataset">
                <Card Hoverable>
                    <CardMeta Title="Dataset Editor" Description="Add dataset" />
                </Card>
            </a>
        </AntDesign.Col>
    </Row>

</div>


@code{
    private string DebugMsg { get; set; }

    private async Task AppConfig_StateChanged(
    ComponentBase source,
    string appConfig)
    {
        if (source != this)
        {
            await InvokeAsync(StateHasChanged);
            DebugMsg = "StateHasChanged";
        }
    }

    //protected override void OnInitialized()
    //{
    //    State.StateChanged += async (source, property)
    //    => await AppConfig_StateChanged(source, property);
    //}
    //public void Dispose()
    //{
    //    State.StateChanged -= async (source, property)
    //    => await AppConfig_StateChanged(source, property);
    //}
}